<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check Orders - Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            background: #f5f5f5;
        }
        h1 {
            color: #e94560;
        }
        .section {
            background: white;
            padding: 2rem;
            margin: 1rem 0;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button {
            background: #e94560;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0.5rem;
        }
        button:hover {
            background: #d63851;
        }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.9rem;
        }
        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #e94560;
            color: white;
        }
        tr:hover {
            background: #f8f9fa;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <h1>üîç Orders Database Checker</h1>

    <div class="section">
        <h2>Current User</h2>
        <button onclick="checkUser()">Check Login Status</button>
        <div id="userInfo"></div>
    </div>

    <div class="section">
        <h2>All Orders (Firebase)</h2>
        <button onclick="checkFirebaseOrders()">Load from Firebase</button>
        <button onclick="checkLocalOrders()">Load from LocalStorage</button>
        <button onclick="autoRefresh()">Auto Refresh (5s)</button>
        <button onclick="stopRefresh()">Stop Auto Refresh</button>
        <div id="ordersInfo"></div>
    </div>

    <div class="section">
        <h2>My Orders Only</h2>
        <button onclick="checkMyOrders()">Show My Orders</button>
        <div id="myOrdersInfo"></div>
    </div>

    <!-- Firebase Configuration -->
    <script src="firebase-config.js"></script>
    <script src="orders.js"></script>
    <script src="auth.js"></script>

    <script>
        let refreshInterval = null;

        setTimeout(() => {
            if (typeof initAuth === 'function') initAuth();
            console.log('Firebase:', useFirebase);
            console.log('Auth:', auth);
            console.log('DB:', db);
        }, 500);

        function checkUser() {
            const div = document.getElementById('userInfo');
            if (currentUser) {
                div.innerHTML = `
                    <div class="status success">
                        <strong>‚úÖ Logged In</strong><br>
                        Email: ${currentUser.email || 'N/A'}<br>
                        Name: ${currentUser.displayName || 'N/A'}<br>
                        UID: ${currentUser.uid || 'N/A'}
                    </div>
                `;
            } else {
                div.innerHTML = `
                    <div class="status warning">
                        ‚ö†Ô∏è Not logged in. Login from main page first.
                    </div>
                `;
            }
        }

        async function checkFirebaseOrders() {
            const div = document.getElementById('ordersInfo');
            div.innerHTML = '<div class="status info">‚è≥ Loading from Firebase...</div>';

            try {
                if (!useFirebase || !db) {
                    div.innerHTML = '<div class="status error">‚ùå Firebase not available</div>';
                    return;
                }

                const snapshot = await db.collection('orders')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();

                const orders = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    orders.push({
                        orderId: doc.id,
                        ...data,
                        createdAt: data.createdAt?.toDate?.() || new Date(data.createdAt)
                    });
                });

                displayOrdersTable(orders, div);
            } catch (error) {
                console.error('Firebase error:', error);
                div.innerHTML = `
                    <div class="status error">
                        ‚ùå Error: ${error.message}<br>
                        <small>Trying without orderBy...</small>
                    </div>
                `;

                // Try without orderBy
                try {
                    const snapshot = await db.collection('orders').get();
                    const orders = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        orders.push({
                            orderId: doc.id,
                            ...data,
                            createdAt: data.createdAt?.toDate?.() || new Date(data.createdAt)
                        });
                    });
                    orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    displayOrdersTable(orders, div);
                } catch (err2) {
                    div.innerHTML += `<div class="status error">‚ùå Fallback also failed: ${err2.message}</div>`;
                }
            }
        }

        function checkLocalOrders() {
            const div = document.getElementById('ordersInfo');
            const ordersJson = localStorage.getItem('roseCollectionOrders');

            if (!ordersJson) {
                div.innerHTML = '<div class="status warning">‚ö†Ô∏è No orders in LocalStorage</div>';
                return;
            }

            try {
                const orders = JSON.parse(ordersJson);
                displayOrdersTable(orders, div);
            } catch (error) {
                div.innerHTML = `<div class="status error">‚ùå Error parsing LocalStorage: ${error.message}</div>`;
            }
        }

        async function checkMyOrders() {
            const div = document.getElementById('myOrdersInfo');

            if (!currentUser) {
                div.innerHTML = '<div class="status warning">‚ö†Ô∏è Please login first</div>';
                return;
            }

            div.innerHTML = '<div class="status info">‚è≥ Loading your orders...</div>';

            try {
                const userEmail = currentUser.email || currentUser.emailAddress;
                let orders = [];

                if (useFirebase && db) {
                    const snapshot = await db.collection('orders')
                        .where('customerEmail', '==', userEmail)
                        .get();

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        orders.push({
                            orderId: doc.id,
                            ...data,
                            createdAt: data.createdAt?.toDate?.() || new Date(data.createdAt)
                        });
                    });
                } else {
                    const allOrders = JSON.parse(localStorage.getItem('roseCollectionOrders') || '[]');
                    orders = allOrders.filter(o => o.customerEmail === userEmail);
                }

                orders.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                displayOrdersTable(orders, div);
            } catch (error) {
                div.innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        function displayOrdersTable(orders, container) {
            if (orders.length === 0) {
                container.innerHTML = '<div class="status warning">‚ö†Ô∏è No orders found</div>';
                return;
            }

            const html = `
                <div class="status success">
                    <strong>‚úÖ Found ${orders.length} order${orders.length !== 1 ? 's' : ''}</strong>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => {
                            const date = new Date(order.createdAt);
                            const itemCount = order.items?.reduce((sum, item) => sum + (item.quantity || 1), 0) || 0;
                            return `
                                <tr>
                                    <td><strong>${order.orderId}</strong></td>
                                    <td>${order.customerName || 'N/A'}</td>
                                    <td>${order.customerEmail || 'N/A'}</td>
                                    <td>${order.customerPhone || 'N/A'}</td>
                                    <td>${itemCount} items</td>
                                    <td>‚Çπ${parseFloat(order.totalAmount || 0).toFixed(2)}</td>
                                    <td><span style="background: #ffc107; padding: 0.25rem 0.5rem; border-radius: 4px;">${order.status || 'pending'}</span></td>
                                    <td>${date.toLocaleDateString()} ${date.toLocaleTimeString()}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
                <details style="margin-top: 1rem;">
                    <summary style="cursor: pointer; font-weight: 600;">View Raw JSON</summary>
                    <pre>${JSON.stringify(orders, null, 2)}</pre>
                </details>
            `;

            container.innerHTML = html;
        }

        function autoRefresh() {
            if (refreshInterval) {
                alert('Auto-refresh already running');
                return;
            }

            refreshInterval = setInterval(() => {
                console.log('Auto-refreshing orders...');
                checkFirebaseOrders();
                if (currentUser) {
                    checkMyOrders();
                }
            }, 5000);

            alert('Auto-refresh enabled (every 5 seconds)');
        }

        function stopRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
                alert('Auto-refresh stopped');
            } else {
                alert('Auto-refresh is not running');
            }
        }

        // Auto-check on load
        setTimeout(() => {
            checkUser();
            checkFirebaseOrders();
        }, 1500);
    </script>
</body>
</html>
